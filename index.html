<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Islamic Calendar - Muslim Mall</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --page-width: 120rem;
      }
      html {
        box-sizing: border-box;
        font-size: 62.5%; /* 10px if 16px default */
      }
      body {
        margin: 0;
        font-family: "Noto Sans", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
        font-variation-settings: "wdth" 100;
        font-size: 1.5rem;
        line-height: 1.8;
        padding-bottom: 50px;
      }
      h1 {
        font-size: 4rem;
      }
      .center {
        text-align: center;
      }
      .page-width {
        max-width: var(--page-width);
        margin: 0 auto;
        padding: 0 1.5rem;
      }
      @media screen and (min-width: 750px) {
        body {
          font-size: 1.6rem;
        }

        .page-width {
          padding: 0 5rem;
        }

        .page-width--narrow {
          padding: 0 9rem;
        }
      }
      @media screen and (min-width: 990px) {
        .page-width--narrow {
          max-width: 72.6rem;
          padding: 0;
        }
      }
    </style>
  </head>
  <body>
    <style>
      .icon {
        display: inline-block;
        width: 1em;
        height: 1em;
        stroke-width: 0;
        stroke: currentColor;
        fill: currentColor;
      }
      .calendar-container {
        --primary-color: #2c67a7;
        --secondary-color: #00afef;
        --text-dark: #222;
        --text-light: #fff;
        --text-gray: #888;
        --background-color: #fff;
        --background-color-2: #f3f3f3;
        --border-color: var(--secondary-color);
        --radius: 5px;
        --shadow-filter: drop-shadow(1px 2px 4px hsla(0, 0%, 0%, 0.1));

        background: #9fd8f9;
        background: linear-gradient(
          0deg,
          rgba(159, 216, 249, 1) 0%,
          rgba(236, 247, 254, 1) 100%
        );
      }
      .calendar-container.dark {
        --background-color: #0a233e;
        --text-dark: #ddd;
        --text-light: #000;
      }
      .calendar-wrapper {
        position: relative;
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
      }

      .page-header-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .page-header {
        font-size: 4rem;
        margin: 40px 0;
        text-align: center;
        color: var(--primary-color);
        line-height: 1;
      }

      .calendar {
        position: relative;
        margin: 0 auto;
      }
      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 0;
        margin-bottom: 12px;
        border-radius: var(--radius);
        position: relative;
        overflow: hidden;
        border: 1px solid var(--secondary-color);
        color: var(--text-dark);
      }
      .calendar-month-year {
        text-align: center;
        width: 100%;
      }
      .h-month-year {
        font-size: 2.1rem;
        font-weight: 700;
        line-height: 1;
      }
      .g-month-year {
        opacity: 0.7;
      }

      .calendar-nav {
        border-radius: 50%;
        background-color: var(--primary-color);
        color: var(--text-light);
        cursor: pointer;
        margin: 0 10px;
        font-size: 2rem;
        transition: transform 0.2s ease;
        padding: 1rem;
        z-index: 2;
      }
      .calendar-nav:hover {
        transform: scale(1.1);
      }

      .day,
      .h-day {
        color: var(--text-dark);
      }
      .days,
      .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
      }
      .weekdays {
        border-top: 1px solid var(--border-color);
        border-left: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
        border-top-left-radius: var(--radius);
        border-top-right-radius: var(--radius);
      }
      .weekday {
        color: var(--text-dark);
        font-weight: 700;
        border-right: 1px solid var(--border-color);
        padding: 5px 0;
      }
      .days {
        border-left: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
        overflow: hidden;
      }
      .day {
        cursor: default;
        height: 70px;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
        position: relative;
      }
      .weekday:nth-child(7n),
      .day:nth-child(7n) {
        border-right: none;
      }
      #tooltip,
      .g-day {
        position: absolute;
      }
      .holiday-indicator,
      .holidays > div::before {
        width: 7px;
        height: 7px;
        background-color: var(--secondary-color);
        border-radius: 50%;
      }
      .day:not(.muted):hover {
        background-color: var(--secondary-color);
      }
      .day.active,
      .day.active:hover {
        background-color: var(--primary-color);
        z-index: 1;
      }
      .h-day {
        font-size: 1.7rem;
        font-weight: 700;
      }
      .g-day {
        top: 7px;
        right: 7px;
        font-size: 1rem;
        opacity: 0.5;
        line-height: 1;
      }
      .weekday:nth-child(6),
      .day:nth-child(7n + 6) .g-day,
      .day:nth-child(7n + 6) .h-day {
        color: green;
      }
      .day.active .g-day,
      .day.active .h-day,
      .day:not(.muted):hover .g-day,
      .day:not(.muted):hover .h-day {
        color: var(--text-light);
      }
      .holiday-indicator {
        position: absolute;
        inset: 0 0 -3.4rem;
        margin: auto;
      }
      .muted {
        cursor: unset;
      }
      .muted .g-day,
      .muted .h-day,
      .muted .holiday-indicator {
        opacity: 0.3;
      }
      .hidden {
        display: none;
      }
      .calendar-footer {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 20px 0 40px;
      }
      .special-date,
      .special-dates-list {
        flex-direction: column;
        display: flex;
      }
      .special-dates-list {
        gap: 1px;
      }
      .special-date-item {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 8px;
      }
      .special-date-item:not(:first-child) {
        border-top: 1px solid var(--border-color);
      }
      .special-date {
        min-width: 60px;
        font-weight: 600;
        color: var(--text-dark);
        align-items: center;
        line-height: 1.2;
      }
      #tooltip {
        background-color: var(--background-color);
        line-height: 1.4;
      }
      .special-date-detail {
        color: var(--text-dark);
        line-height: 1.4;
        border-left: 3px solid var(--secondary-color);
        display: flex;
        flex-direction: column;
        padding: 5px 5px 5px 10px;
        gap: 4px;
        width: 100%;
      }
      .special-hijri-date {
        color: var(--text-gray);
        font-size: 1.4rem;
      }
      #tooltip {
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        filter: var(--shadow-filter);
        color: var(--text-dark);
        padding: 7px 14px;
        z-index: 1000;
        width: max-content;
        max-width: 70%;
        pointer-events: none;
      }
      .holidays > div::before {
        content: "";
        margin-right: 0.5ch;
        border-radius: 50%;
        display: inline-block;
      }
    </style>
    <!-- BEGIN SVG Defs -->
    <svg
      aria-hidden="true"
      style="position: absolute; width: 0; height: 0; overflow: hidden"
      version="1.1"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
    >
      <defs>
        <symbol id="icon-chevron-thin-right" viewBox="0 0 20 20">
          <path
            d="M13.25 10l-7.141-7.42c-0.268-0.27-0.268-0.707 0-0.979 0.268-0.27 0.701-0.27 0.969 0l7.83 7.908c0.268 0.271 0.268 0.709 0 0.979l-7.83 7.908c-0.268 0.271-0.701 0.27-0.969 0s-0.268-0.707 0-0.979l7.141-7.417z"
          />
        </symbol>
        <symbol id="icon-chevron-thin-left" viewBox="0 0 20 20">
          <path
            d="M13.891 17.418c0.268 0.272 0.268 0.709 0 0.979s-0.701 0.271-0.969 0l-7.83-7.908c-0.268-0.27-0.268-0.707 0-0.979l7.83-7.908c0.268-0.27 0.701-0.27 0.969 0s0.268 0.709 0 0.979l-7.141 7.419 7.141 7.418z"
          />
        </symbol>
      </defs>
    </svg>
    <!-- END SVG Defs -->
    <div class="page">
      <!-- BEGIN Calendar HTML -->
      <div class="calendar-container">
        <div class="page-header-container">
          <h1 class="page-header">Islamic Calendar</h1>
        </div>

        <div class="calendar-wrapper page-width page-width--narrow">
          <div class="calendar">
            <div class="calendar-header">
              <div id="prevMonth" class="calendar-nav">
                <svg class="icon icon-chevron-thin-left">
                  <use xlink:href="#icon-chevron-thin-left"></use>
                </svg>
              </div>
              <div class="calendar-month-year">
                <div id="hMonthYear" class="h-month-year">&nbsp;</div>
                <div id="gMonthYear" class="g-month-year">&nbsp;</div>
              </div>
              <div id="nextMonth" class="calendar-nav">
                <svg class="icon icon-chevron-thin-right">
                  <use xlink:href="#icon-chevron-thin-right"></use>
                </svg>
              </div>
            </div>

            <div class="calendar-grid">
              <div class="weekdays">
                <div class="weekday">Sun</div>
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
              </div>

              <div id="calendarDays" class="days">
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
                <div class="day hidden">&nbsp;</div>
              </div>

              <div id="tooltip" class="hidden" role="tooltip"></div>

              <div class="calendar-footer">
                <div id="specialDates" class="special-dates-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Elements
      const calendar = document.querySelector(".calendar");
      const gMonthYear = document.querySelector("#gMonthYear");
      const hMonthYear = document.querySelector("#hMonthYear");
      const calendarDays = document.querySelector("#calendarDays");
      const prevMonthBtn = document.querySelector("#prevMonth");
      const nextMonthBtn = document.querySelector("#nextMonth");
      const specialDates = document.querySelector("#specialDates");
      const tooltip = document.querySelector("#tooltip");

      const hijriMonthCache = {};
      let todayHijri = null;
      let currentHijri = null;

      // Render the calendar for the current Hijri month
      async function renderCalendar() {
        specialDates.innerHTML = "";

        try {
          const currMonth = await getHijriMonth(
            currentHijri.year,
            currentHijri.month
          );
          if (!currMonth.length) {
            console.error("No calendar data");
            return;
          }

          const weekDaysMap = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
          ];
          const firstDayIndex = weekDaysMap.indexOf(
            currMonth[0].gregorian.weekday.en
          );
          const daysInCurrent = currMonth.length;
          const needsExtraRow = firstDayIndex + daysInCurrent > 35;
          const allCells = calendarDays.querySelectorAll(".day");

          const needsPrev = firstDayIndex > 0;
          const lastVisibleIndex = firstDayIndex + daysInCurrent - 1;
          const needsNext = lastVisibleIndex < (needsExtraRow ? 41 : 34);

          // Fetch previous and next months if needed
          const [prevMonth, nextMonth] = await Promise.all([
            needsPrev
              ? getHijriMonth(
                  currentHijri.month === 1
                    ? currentHijri.year - 1
                    : currentHijri.year,
                  currentHijri.month === 1 ? 12 : currentHijri.month - 1
                )
              : null,
            needsNext
              ? getHijriMonth(
                  currentHijri.month === 12
                    ? currentHijri.year + 1
                    : currentHijri.year,
                  currentHijri.month === 12 ? 1 : currentHijri.month + 1
                )
              : null,
          ]);

          // Fill calendar cells
          for (let i = 0; i < 42; i++) {
            const cell = allCells[i];
            cell.innerHTML = "";

            // Hide extra row cells when not needed
            const isExtraRow = i > 34;
            cell.classList.toggle("hidden", !needsExtraRow && isExtraRow);

            if (isExtraRow && !needsExtraRow) continue;

            if (i < firstDayIndex) {
              renderCell(
                cell,
                prevMonth[prevMonth.length - (firstDayIndex - i)],
                true
              );
            } else if (i >= firstDayIndex + daysInCurrent) {
              renderCell(
                cell,
                nextMonth[i - (firstDayIndex + daysInCurrent)],
                true
              );
            } else {
              renderCell(cell, currMonth[i - firstDayIndex], false);
            }
          }

          // Set header texts
          setHeaderTexts(currMonth);

          // Render special dates/events
          renderSpecialDates(currMonth);
        } catch (err) {
          console.error("Failed to fetch calendar data:", err);
        }
      }

      // Render a single calendar cell
      function renderCell(cell, dayData, isMuted = false) {
        const g = dayData.gregorian;
        const h = dayData.hijri;

        const hijriFullDate = `${h.day} ${h.month.en} ${h.year}`;
        const gregorianFullDate = `${g.day} ${g.month.en} ${g.year}`;
        const tooltipHTML = `${hijriFullDate}<br>${gregorianFullDate}<br>
  <div class="holidays">${
    h.holidays
      ? h.holidays.map((holiday) => `<div>${holiday}</div>`).join("")
      : ""
  }</div>`;

        cell.innerHTML = `
    <span class="g-day">${g.day}</span>
    <span class="h-day">${h.day}</span>
    ${
      h.holidays && h.holidays.length
        ? `<span class="holiday-indicator"></span>`
        : ""
    }
  `;

        // Tooltip
        cell.onmouseenter = !isMuted && (() => showTooltip(cell, tooltipHTML));
        cell.onmouseleave = !isMuted && (() => tooltip.classList.add("hidden"));

        cell.classList.toggle("muted", isMuted);

        if (
          todayHijri &&
          +h.day === +todayHijri.day &&
          +h.month.number === +todayHijri.month.number &&
          +h.year === +todayHijri.year
        ) {
          cell.classList.add("active");
        } else {
          cell.classList.remove("active");
        }
      }

      // Set the calendar header texts
      function setHeaderTexts(currMonth) {
        const firstG = currMonth[0].gregorian;
        const lastG = currMonth.at(-1).gregorian;
        hMonthYear.textContent = `${currMonth[0].hijri.month.en} ${currentHijri.year}`;
        let monthYearText;
        if (firstG.year !== lastG.year) {
          monthYearText = `${firstG.month.en} ${firstG.year} - ${lastG.month.en} ${lastG.year}`;
        } else if (firstG.month.number !== lastG.month.number) {
          monthYearText = `${firstG.month.en} - ${lastG.month.en} ${firstG.year}`;
        } else {
          monthYearText = `${firstG.month.en} ${firstG.year}`;
        }
        gMonthYear.textContent = monthYearText;
      }

      // Render the list of special dates/events
      function renderSpecialDates(currMonth) {
        const events = currMonth
          .filter((d) => d.hijri.holidays?.length)
          .map((d) => ({
            gDay: +d.gregorian.day,
            gMonth: d.gregorian.month.en.slice(0, 3),
            hDate: `${d.hijri.day} ${d.hijri.month.en}`,
            title: d.hijri.holidays[0],
          }));

        if (events.length) {
          const fragment = document.createDocumentFragment();
          events.forEach(({ gDay, gMonth, hDate, title }) => {
            const item = document.createElement("div");
            item.className = "special-date-item";
            item.innerHTML = `
        <div class="special-date"><span>${gDay}</span> <span>${gMonth}</span></div>
        <div class="special-date-detail">
          <span>${title}</span>
          <span class="special-hijri-date">${hDate}</span>
        </div>
      `;
            fragment.appendChild(item);
          });
          specialDates.appendChild(fragment);
        } else {
          specialDates.innerHTML =
            "<div class='special-date-item'><div>There are no Islamic events for this month.</div></div>";
        }
      }

      // Navigation event listeners
      prevMonthBtn.addEventListener("click", () => {
        if (--currentHijri.month < 1) {
          currentHijri.month = 12;
          currentHijri.year--;
        }
        renderCalendar();
      });

      nextMonthBtn.addEventListener("click", () => {
        if (++currentHijri.month > 12) {
          currentHijri.month = 1;
          currentHijri.year++;
        }
        renderCalendar();
      });

      // Generic fetch helper function
      async function fetchJSON(url) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } catch (err) {
          return null;
        }
      }

      // Cache key prefix for localStorage
      const HIJRI_CACHE_PREFIX = "hijriMonth_";

      // Helper function to extract comparable date data from API response
      function extractComparableData(apiData) {
        if (!Array.isArray(apiData)) return [];

        return apiData.map((dayData) => ({
          hijriDate: dayData.hijri?.date,
          gregorianDate: dayData.gregorian?.date,
          hijriDay: dayData.hijri?.day,
          gregorianDay: dayData.gregorian?.day,
        }));
      }

      // Helper function to compare two datasets
      function hasDataChanged(cachedData, newData) {
        if (!cachedData || !newData) return true;
        if (cachedData.length !== newData.length) return true;

        const cachedComparable = extractComparableData(cachedData);
        const newComparable = extractComparableData(newData);

        return (
          JSON.stringify(cachedComparable) !== JSON.stringify(newComparable)
        );
      }

      // Fetch Hijri month data with caching
      async function getHijriMonth(year, month) {
        const key = `${year}-${month}`;
        if (hijriMonthCache[key]) return hijriMonthCache[key];

        const json = await fetchJSON(
          `https://api.aladhan.com/v1/hToGCalendar/${month}/${year}`
        );
        const data = json?.data || [];

        const monthNameMap = {
          "Rabīʿ al-awwal": "Rabīʿ al-Awwal",
          "Rabīʿ al-thānī": "Rabīʿ ath-Thānī",
          "Jumādá al-ūlá": "Jumādāl-Ūlā",
          "Jumādá al-ākhirah": "Jumādāth-Thānī",
          "Dhū al-Qaʿdah": "Dhūl-Qaʿdah",
          "Dhū al-Ḥijjah": "Dhūl-Ḥijjah",
        };

        // Modify
        data.forEach((h) => {
          if (h.hijri && Array.isArray(h.hijri.holidays)) {
            h.hijri.holidays = h.hijri.holidays.filter(
              (item) => !(item.startsWith("Urs") || item.startsWith("Birth"))
            );
          }
          const month = h.hijri.month.en;
          if (monthNameMap[month]) {
            h.hijri.month.en = monthNameMap[month];
          }
        });

        hijriMonthCache[key] = data;
        return data;
      }

      // Show tooltip and auto position inside calendar
      function showTooltip(el, tooltipHTML) {
        tooltip.innerHTML = tooltipHTML;
        tooltip.classList.remove("hidden"); // must be visible before measuring

        const rect = el.querySelector(".h-day").getBoundingClientRect();
        const tRect = tooltip.getBoundingClientRect();
        const cRect = calendar.getBoundingClientRect();

        let left = rect.left - cRect.left;

        // Prevent overflow right
        if (left + tRect.width > cRect.width) {
          left = rect.left - cRect.left + (rect.width - tRect.width);
        }

        tooltip.style.left = `${left}px`;
        tooltip.style.top = rect.bottom - cRect.top + 5 + "px";
      }

      // Initial calendar load
      (async function initCalendar() {
        const today = new Date();
        // Format to DD-MM-YYYY
        const todayStr = today.toLocaleDateString("en-GB").replace(/\//g, "-");
        const json = await fetchJSON(
          `https://api.aladhan.com/v1/gToH/${todayStr}`
        );
        if (!json) return; // stops if offline or API fails

        const hijri = json.data.hijri;
        todayHijri = {
          day: +hijri.day,
          month: { number: +hijri.month.number },
          year: +hijri.year,
        };
        currentHijri = { year: +hijri.year, month: +hijri.month.number };
        renderCalendar(currentHijri);
      })();
    </script>
  </body>
</html>
